using System;
using System.Collections.Generic;
using UnityEngine;

// Token: 0x0200007D RID: 125
public class AnimationEffect : MonoBehaviour
{
	// Token: 0x06000641 RID: 1601 RVA: 0x0000EA01 File Offset: 0x0000CC01
	private void Start()
	{
		this.m_animator = base.GetComponent<Animator>();
	}

	// Token: 0x06000642 RID: 1602 RVA: 0x00051BF8 File Offset: 0x0004FDF8
	public void Effect(AnimationEvent e)
	{
		string stringParameter = e.stringParameter;
		GameObject gameObject = e.objectReferenceParameter as GameObject;
		if (gameObject == null)
		{
			return;
		}
		Transform transform = null;
		if (stringParameter.Length > 0)
		{
			transform = Utils.FindChild(base.transform, stringParameter, Utils.IterativeSearchType.DepthFirst);
		}
		if (transform == null)
		{
			transform = (this.m_effectRoot ? this.m_effectRoot : base.transform);
		}
		UnityEngine.Object.Instantiate<GameObject>(gameObject, transform.position, transform.rotation);
	}

	// Token: 0x06000643 RID: 1603 RVA: 0x00051C74 File Offset: 0x0004FE74
	public void Attach(AnimationEvent e)
	{
		string stringParameter = e.stringParameter;
		GameObject gameObject = e.objectReferenceParameter as GameObject;
		bool flag = e.intParameter < 0;
		int intParameter = e.intParameter;
		bool flag2 = intParameter == 10 || intParameter == -10;
		if (gameObject == null)
		{
			return;
		}
		if (stringParameter == "")
		{
			ZLog.LogWarning("No joint name specified for Attach in animation " + e.animatorClipInfo.clip.name);
			return;
		}
		Transform transform = Utils.FindChild(base.transform, stringParameter, Utils.IterativeSearchType.DepthFirst);
		if (transform == null)
		{
			ZLog.LogWarning("Failed to find attach joint " + stringParameter + " for animation " + e.animatorClipInfo.clip.name);
			return;
		}
		this.ClearAttachment(transform);
		GameObject gameObject2 = UnityEngine.Object.Instantiate<GameObject>(gameObject, transform.position, transform.rotation);
		Vector3 localScale = gameObject2.transform.localScale;
		gameObject2.transform.SetParent(transform, true);
		if (flag2)
		{
			gameObject2.transform.localScale = localScale;
		}
		if (flag)
		{
			return;
		}
		if (this.m_attachments == null)
		{
			this.m_attachments = new List<GameObject>();
		}
		this.m_attachments.Add(gameObject2);
		this.m_attachStateHash = e.animatorStateInfo.fullPathHash;
		base.CancelInvoke("UpdateAttachments");
		base.InvokeRepeating("UpdateAttachments", 0.1f, 0.1f);
	}

	// Token: 0x06000644 RID: 1604 RVA: 0x00051DE0 File Offset: 0x0004FFE0
	private void ClearAttachment(Transform parent)
	{
		if (this.m_attachments == null)
		{
			return;
		}
		foreach (GameObject gameObject in this.m_attachments)
		{
			if (gameObject && gameObject.transform.parent == parent)
			{
				this.m_attachments.Remove(gameObject);
				UnityEngine.Object.Destroy(gameObject);
				break;
			}
		}
	}

	// Token: 0x06000645 RID: 1605 RVA: 0x00051E68 File Offset: 0x00050068
	public void RemoveAttachments()
	{
		if (this.m_attachments == null)
		{
			return;
		}
		foreach (GameObject obj in this.m_attachments)
		{
			UnityEngine.Object.Destroy(obj);
		}
		this.m_attachments.Clear();
	}

	// Token: 0x06000646 RID: 1606 RVA: 0x00051ECC File Offset: 0x000500CC
	private void UpdateAttachments()
	{
		if (this.m_attachments != null && this.m_attachments.Count > 0)
		{
			if (this.m_attachStateHash != this.m_animator.GetCurrentAnimatorStateInfo(0).fullPathHash && this.m_attachStateHash != this.m_animator.GetNextAnimatorStateInfo(0).fullPathHash)
			{
				this.RemoveAttachments();
				return;
			}
		}
		else
		{
			base.CancelInvoke("UpdateAttachments");
		}
	}

	// Token: 0x040007EE RID: 2030
	public Transform m_effectRoot;

	// Token: 0x040007EF RID: 2031
	private Animator m_animator;

	// Token: 0x040007F0 RID: 2032
	private List<GameObject> m_attachments;

	// Token: 0x040007F1 RID: 2033
	private int m_attachStateHash;
}
