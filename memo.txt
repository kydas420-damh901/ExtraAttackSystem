ゲーム内のバニラの武器種分類 と メモ
Axe         片手
Clubs       片手
Swords      片手
Spears      片手    左手装備できない
Polearms    両手 
knifes      片手
Fists       両手    バニラモーションはUnarmed と共通
BattleAxes  両手 
GreatSwords 両手
Unarmed     両手    バニラモーションはFistと共通
Dual Axes   両手
Dual Knifes 両手
Sledges     両手    バニラは通常攻撃しかないがqtg割り当てる
Torch       片手

Shileds     片手    左手に shiled だけ
Axes + Shileds
Swords + Shileds
Clubs + Shileds
Torch + Sword or Axe or Club or Spear or Knife
Torch + Unarmed

Bows        両手
Cross Bows  両手
staff       両手


アニメーション割当暫定版
Axe             
Clubs       
Swords      
Spears          左手装備できない
Polearms     
knifes      
Fists           バニラモーションはUnarmed と共通
BattleAxes   
GreatSwords 
Unarmed         バニラモーションはFistと共通
Dual Axes   
Dual Knifes 
Sledges         バニラは通常攻撃しかないがqtg割り当てる
Torch       

Shileds + unarmed     
Axes + Shileds
Swords + Shileds
Clubs + Shileds

Torch + Sword or Axe or Club or Spear or Knife
Torch + Unarmed

Bows
CrossBows
staff 



キー（変更可能：デフォルトはQ T G）押下で カスタムアニメーションの攻撃ができる
判定・ダメージ・スタミナ消費 音の有無、VFXの有無 を yaml で設定可能 ※将来的にはsound VFX を差し替えられるように。現在は未実装

・本MODで用意するアニメーション（ assetbundle 内アニメーション）
animation timing などはコード内で設定
animation clip もすべて指定


・ユーザーも追加できるアニメーション
本MODで用意した 武器種類別のアニメーションもyamlファイル(例：BaseAnimation.yaml)で置き換えと設定可能
個別武器ごとにACを用意する
yamlファイルで animation timing、判定やダメージなど設定可能
animation clip は指定フォルダに入れて、yamlファイルで設定することで置き換え可能

WeaponTypes yaml は アルファベッド順固定
Axe             
Clubs       
Swords      
Spears          左手装備できない
knifes      
Polearms     
BattleAxes   
GreatSwords 
Dual Axes   
Dual Knifes 
Sledges         バニラは通常攻撃しかないがqtg割り当てる
Fists           バニラモーションはUnarmed と共通
Unarmed         バニラモーションはFistと共通
Torch       

Shileds + unarmed     
Axes + Shileds
Swords + Shileds
Clubs + Shileds

Torch + Sword or Axe or Club or Spear or Knife

× 置き換え Animation Clip 指定 装備している武器のトリガーとクリップがあっていないと再生されない
- Unarmed/Fists unarmed_kick
- Knives:       Knife JumpAttack
- BattleAxes    BattleAxeAltAttack
- Spears:       throw_spear
- Swords:       Sword-Attack-R4
- Axes:         Axe Secondary Attack
- GreatSwords   Greatsword Secondary Attack
- Polearms      Atgeir360Attack
他の武器種、個別武器も上記ルールに合わせて指定 
※現在は、QTGすべて装備している武器のセカンダリ攻撃を設定

トリガー名とクリップ名とイベント名
axe_secondary			[Axe Secondary Attack] - Length: 1.400s, FrameRate: 30, Legacy: False, Events: 0
sword_secondary			[Sword-Attack-R4] - Length: 1.400s, FrameRate: 30, Legacy: False, Events: 0
mace_secondary			[MaceAltAttack] - Length: 1.400s, FrameRate: 30, Legacy: False, Events: 0
atgeir_secondary		[Atgeir360Attack] - Length: 2.167s, FrameRate: 30, Legacy: False, Events: 6
battleaxe_secondary		[BattleAxeAltAttack] - Length: 0.857s, FrameRate: 30, Legacy: False, Events: 5
knife_secondary			[Knife JumpAttack] - Length: 1.400s, FrameRate: 30, Legacy: False, Events: 0
dual_knives_secondary	[Knife Attack Leap] - Length: 1.500s, FrameRate: 30, Legacy: False, Events: 2
greatsword_secondary	[Greatsword Secondary Attack] - Length: 1.400s, FrameRate: 30, Legacy: False, Events: 0
dualaxes_secondary		[DualAxes Attack Cleave] - Length: 1.900s, FrameRate: 30, Legacy: False, Events: 3
 [Kickstep] - Length: 1.833s, FrameRate: 30, Legacy: False, Events: 4
[throw_spear] - Length: 1.133s, FrameRate: 30, Legacy: False, Events: 5

greatsword
[Info   :Extra Attack System] [System] attackRange: 2.6
[Info   :Extra Attack System] [System] attackHeight: 1
[Info   :Extra Attack System] [System] attackOffset: 0
[Info   :Extra Attack System] [System] attackAngle: 90
[Info   :Extra Attack System] [System] attackRayWidth: 0.5
[Info   :Extra Attack System] [System] attackRayWidthCharExtra: 0
[Info   :Extra Attack System] [System] attackHeightChar1: -0.63
[Info   :Extra Attack System] [System] attackHeightChar2: 0.71
[Info   :Extra Attack System] [System] maxYAngle: 0

battleaxe
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

clubs
[Info   :Extra Attack System] [System] === VANILLA TIMING VALUES: MaceAltAttack ===
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

swords
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

axe
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

polearms
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

Knives
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000

dual knives
[Info   :Extra Attack System] [System] Vanilla HitTiming: 0.450
[Info   :Extra Attack System] [System] Vanilla TrailOnTiming: 0.350
[Info   :Extra Attack System] [System] Vanilla TrailOffTiming: 0.700
[Info   :Extra Attack System] [System] Vanilla SpeedTiming: 0.000
[Info   :Extra Attack System] [System] Vanilla DodgeMortalTiming: 0.000









1. 根本的な問題
YAMLファイルは正常に読み込まれていたが、ConvertDirectMappingsToAocTypesでconfig.AocTypes.Count: 0となっていた
カスタムアニメーションは実際には動作していたが、YAML設定値が反映されていない状態
2. 具体的な問題点
3. ログから判明した事実
起動時: ReplacementMapにデータが正しく設定されている
YAML保存: SaveWeaponTypesConfigで正常に書き込み
YAML読み込み: ファイルは存在し、内容も読み込まれている
デシリアライズ: config.Axes.Count: 0 で空になっている
🛠️ 修正内容
1. デバッグログの追加





// 統一前: ea_secondary_Q, ea_secondary_T, ea_secondary_G
// 統一後: secondary_Q, secondary_T, secondary_G





## 解決策: Prefix で m_attackStamina を変更
スキルボーナスを活かすには、Prefix で基準値を変更してバニラ計算を続行:
csharp[HarmonyPatch(typeof(Attack), "GetAttackStamina")]
public static class Attack_GetAttackStamina_Prefix
{
    public static void Prefix(Attack __instance, Humanoid ___m_character)
    {
        if (___m_character is Player player && EAS_CommonUtils.IsPlayerInExtraAttack(player))
        {
            // YAMLから基準スタミナ値を取得
            float yamlBaseStamina = GetYAMLBaseStaminaCost(...);
            
            // m_attackStaminaを上書き
            __instance.m_attackStamina = yamlBaseStamina;
            
            // バニラの計算続行:
            // - 装備補正
            // - SEMan補正
            // - スキル補正 (-33%)
            // - HP補正
        }
    }
}

計算例
YAML設定: StaminaCost: 60（基準値）
スキルレベル計算最終コスト060 × 1.0 × (1 - 0.33×0.0)605060 × 1.0 × (1 - 0.33×0.5)50.110060 × 1.0 × (1 - 0.33×1.0)40.2
スキルレベルが高いほどスタミナ消費が減る = バニラと同じ仕様


AnimationReplacement_IndividualWeapons.yaml このファイルだけ
だけ空でも再生成しない
他は全yaml 空なら再生成
全yamlファイルがなければ再生成
全yaml 中身があれば、何もしない＝ユーザー設定維持


「1フレームだけ座り状態が見える」──これは Animatorのステートが一瞬 sit にあることが原因です。
これはカスタムアニメーションやAOC切り替えが遅れて適用されるせいで、その1フレだけ「バニラの座り状態」が走ってしまうという典型的な問題です。

✅ 原因を整理すると：
状態	内容
初期状態	プレイヤーが sit ステートに入っている（または残っている）
カスタムアニメを再生	SetTrigger() や Play() を実行
でも	AnimatorのRuntimeControllerやステートが切り替わる前に1フレーム描画される
結果	一瞬だけ sit の姿勢が表示される → その後に正しいアニメ再生される
✅ 解決アプローチ一覧
① 永続AOC運用 + バニラ相当Idleへの即時切り替え（推奨）
// 座り状態フラグを解除
animator.SetBool(ZSyncAnimation.GetHash("emote_sit"), false);

// Idleステートを即時に指定
animator.Play("Idle", 0, 0f);

// 少し待ってから Trigger
ZSyncAnimation.SetTrigger(animator, "MaceAltAttack");


Play("Idle") を Trigger直前に実行するのが重要。これで1フレームの sit 表示を消せます。

② 永続AOCを導入して、そもそもACの切り替えを避ける

RuntimeAnimatorController の差し替えは1フレーム遅れる

永続AOCを使えば Animator の中身（Clipマッピング）だけを変えるため、ステート維持されやすい

→ sit → Idle への移行が安定しやすくなる

③ カスタムTrigger前に一度 Animator をリセット（危険あり）
animator.Rebind();
animator.Update(0f);


Rebind() はすべてのパラメータを初期化するため、慎重に使う必要あり

sit 状態も解除されるが、他の挙動に副作用が出やすい

④ 専用の「待機状態アニメ（Idle準備アニメ）」を作る

sit から attack へ直接切り替えるのではなく、

sit → idle短アニメ → attack という短い中継アニメを用意する

✅ 最も現実的な対応は？

Trigger前に Play("Idle") を挟む
AnimatorControllerは永続AOC方式にする

この2つを併用すれば、ほとんどのケースで「座りが一瞬表示される」問題は解消されます。